from fastapi import FastAPI, Depends, HTTPException, status
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from sqlalchemy.orm import Session
from sqlalchemy import func, extract
from typing import List
from datetime import timedelta, datetime, date
import uvicorn
import os

# æ—¢å­˜ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
from database import get_db, create_tables, DailySales, User, DailyReport, Receipt
from schemas import (
    SalesInput, SalesResponse, UserCreate, UserLogin, UserResponse, Token,
    DailyReportInput, DailyReportResponse, DailyCalculationResponse, ReceiptResponse
)
from auth import (
    get_password_hash, 
    authenticate_user, 
    create_access_token, 
    get_current_active_user,
    require_manager,
    ACCESS_TOKEN_EXPIRE_MINUTES
)

app = FastAPI(title="ãƒãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  API", version="2.0.0")

# CORSè¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒå¯¾å¿œï¼‰
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # é–‹ç™ºæ®µéšã§ã¯å…¨ã¦ã®ã‚ªãƒªã‚¸ãƒ³ã‚’è¨±å¯
    allow_credentials=True,
    allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
    allow_headers=["*"],
)

# ãƒ—ãƒªãƒ•ãƒ©ã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ˜ç¤ºçš„å‡¦ç†
@app.options("/{path:path}")
async def handle_options(path: str):
    return JSONResponse(
        content={},
        headers={
            "Access-Control-Allow-Origin": "*",
            "Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS",
            "Access-Control-Allow-Headers": "*",
            "Access-Control-Max-Age": "86400",
        }
    )

# UTF-8ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
@app.middleware("http")
async def add_charset_header(request, call_next):
    response = await call_next(request)
    if response.headers.get("content-type", "").startswith("application/json"):
        response.headers["content-type"] = "application/json; charset=utf-8"
    return response

# ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
@app.on_event("startup")
def startup_event():
    create_tables()

@app.get("/")
async def root():
    return JSONResponse(
        content={"message": "ãƒãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  API ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™"},
        media_type="application/json; charset=utf-8"
    )

@app.get("/api/health")
async def health_check():
    return JSONResponse(
        content={"status": "OK", "message": "API is running"},
        media_type="application/json; charset=utf-8"
    )

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²API
@app.post("/api/auth/register", response_model=UserResponse)
def register_user(user_data: UserCreate, db: Session = Depends(get_db)):
    try:
        # ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
        existing_user = db.query(User).filter(User.email == user_data.email).first()
        if existing_user:
            raise HTTPException(
                status_code=status.HTTP_400_BAD_REQUEST,
                detail="ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™"
            )
        
        # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
        hashed_password = get_password_hash(user_data.password)
        db_user = User(
            email=user_data.email,
            password_hash=hashed_password,
            name=user_data.name,
            role=user_data.role
        )
        db.add(db_user)
        db.commit()
        db.refresh(db_user)
        return db_user
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}"
        )

# ãƒ­ã‚°ã‚¤ãƒ³API
@app.post("/api/auth/login", response_model=Token)
def login_user(user_data: UserLogin, db: Session = Depends(get_db)):
    user = authenticate_user(db, user_data.email, user_data.password)
    if not user:
        raise HTTPException(
            status_code=status.HTTP_401_UNAUTHORIZED,
            detail="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™",
            headers={"WWW-Authenticate": "Bearer"},
        )
    access_token_expires = timedelta(minutes=ACCESS_TOKEN_EXPIRE_MINUTES)
    access_token = create_access_token(
        data={"sub": user.email}, expires_delta=access_token_expires
    )
    return {
        "access_token": access_token,
        "token_type": "bearer",
        "user": user
    }

# ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾—API
@app.get("/api/auth/me", response_model=UserResponse)
def get_current_user_info(current_user: User = Depends(get_current_active_user)):
    return current_user

# === æ–°ã—ã„æ—¥å ±API ===

# æ—¥å ±æå‡ºAPI
@app.post("/api/daily-report", response_model=DailyReportResponse)
def create_daily_report(
    report_data: DailyReportInput,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    try:
        # æ—¥å ±ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        db_report = DailyReport(
            date=report_data.date,
            employee_name=report_data.employee_name,
            total_sales=report_data.total_sales,
            alcohol_cost=report_data.alcohol_cost,
            other_expenses=report_data.other_expenses,
            card_sales=report_data.card_sales,
            drink_count=report_data.drink_count,
            champagne_type=report_data.champagne_type,
            champagne_price=report_data.champagne_price,
            work_start_time=report_data.work_start_time,
            work_end_time=report_data.work_end_time
        )
        db.add(db_report)
        db.commit()
        db.refresh(db_report)
        
        # ä¼ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        for receipt_data in report_data.receipts:
            db_receipt = Receipt(
                daily_report_id=db_report.id,
                customer_name=receipt_data.customer_name,
                employee_name=receipt_data.employee_name,
                drink_count=receipt_data.drink_count,
                champagne_type=receipt_data.champagne_type,
                champagne_price=receipt_data.champagne_price,
                amount=receipt_data.amount,
                is_card=receipt_data.is_card
            )
            db.add(db_receipt)
        
        db.commit()
        
        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
        db.refresh(db_report)
        return db_report
        
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"æ—¥å ±ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}"
        )

# æ—¥å ±ä¸€è¦§å–å¾—API
@app.get("/api/daily-reports", response_model=List[DailyReportResponse])
def get_daily_reports(
    skip: int = 0,
    limit: int = 100,
    employee_name: str = None,
    start_date: date = None,
    end_date: date = None,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    query = db.query(DailyReport)
    
    # æ¨©é™ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if current_user.role != "manager":
        query = query.filter(DailyReport.employee_name == current_user.name)
    elif employee_name:
        query = query.filter(DailyReport.employee_name == employee_name)
    
    # æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
    if start_date:
        query = query.filter(DailyReport.date >= start_date)
    if end_date:
        query = query.filter(DailyReport.date <= end_date)
    
    reports = query.order_by(DailyReport.date.desc()).offset(skip).limit(limit).all()
    return reports

# ç‰¹å®šã®æ—¥å ±å–å¾—API
@app.get("/api/daily-report/{report_id}", response_model=DailyReportResponse)
def get_daily_report(
    report_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    report = db.query(DailyReport).filter(DailyReport.id == report_id).first()
    if not report:
        raise HTTPException(status_code=404, detail="æ—¥å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # æ¨©é™ãƒã‚§ãƒƒã‚¯
    if current_user.role != "manager" and report.employee_name != current_user.name:
        raise HTTPException(status_code=403, detail="ã“ã®æ—¥å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“")
    
    return report

# æ—¥å ±ã®è¨ˆç®—çµæœå–å¾—API
@app.get("/api/daily-report/{report_id}/calculations", response_model=DailyCalculationResponse)
def get_daily_report_calculations(
    report_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    report = db.query(DailyReport).filter(DailyReport.id == report_id).first()
    if not report:
        raise HTTPException(status_code=404, detail="æ—¥å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # æ¨©é™ãƒã‚§ãƒƒã‚¯
    if current_user.role != "manager" and report.employee_name != current_user.name:
        raise HTTPException(status_code=403, detail="ã“ã®æ—¥å ±ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“")
    
    # è¨ˆç®—
    total_receipt_amount = sum(receipt.amount for receipt in report.receipts)
    total_expenses = report.alcohol_cost + report.other_expenses
    cash_remaining = report.total_sales - report.card_sales
    net_profit = report.total_sales - total_expenses
    
    return {
        "net_profit": net_profit,
        "cash_remaining": cash_remaining,
        "total_expenses": total_expenses,
        "total_receipt_amount": total_receipt_amount
    }

# === æ—¢å­˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿APIï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ä¿æŒï¼‰ ===

# å£²ä¸Šãƒ‡ãƒ¼ã‚¿æŠ•ç¨¿APIï¼ˆèªè¨¼å¿…é ˆï¼‰
@app.post("/api/sales", response_model=SalesResponse)
def create_sales(
    sales_data: SalesInput, 
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    try:
        # æ–°ã—ã„å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        db_sales = DailySales(
            date=sales_data.date,
            employee_name=sales_data.employee_name,
            total_sales=sales_data.total_sales,
            drink_count=sales_data.drink_count,
            champagne_count=sales_data.champagne_count,
            catch_count=sales_data.catch_count,
            work_hours=sales_data.work_hours
        )
        db.add(db_sales)
        db.commit()
        db.refresh(db_sales)
        return db_sales
    except Exception as e:
        db.rollback()
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail=f"å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: {str(e)}"
        )

# å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—APIï¼ˆèªè¨¼å¿…é ˆï¼‰
@app.get("/api/sales", response_model=List[SalesResponse])
def get_sales(
    skip: int = 0, 
    limit: int = 100, 
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    # åº—é•·ã¯å…¨ãƒ‡ãƒ¼ã‚¿ã€å¾“æ¥­å“¡ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º
    if current_user.role == "manager":
        sales = db.query(DailySales).order_by(DailySales.date.desc()).offset(skip).limit(limit).all()
    else:
        sales = db.query(DailySales).filter(
            DailySales.employee_name == current_user.name
        ).order_by(DailySales.date.desc()).offset(skip).limit(limit).all()
    return sales

# æ—¥æ¬¡å£²ä¸Šé›†è¨ˆAPIï¼ˆèªè¨¼å¿…é ˆï¼‰
@app.get("/api/sales/daily-summary")
def get_daily_summary(
    target_date: str = None, 
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    if target_date:
        target = datetime.fromisoformat(target_date).date()
    else:
        target = date.today()
    
    # æ¨©é™ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    query = db.query(DailySales).filter(DailySales.date == target)
    if current_user.role != "manager":
        query = query.filter(DailySales.employee_name == current_user.name)
    
    # æŒ‡å®šæ—¥ã®å£²ä¸Šåˆè¨ˆ
    daily_total = query.with_entities(func.sum(DailySales.total_sales)).scalar() or 0
    drinks_total = query.with_entities(func.sum(DailySales.drink_count)).scalar() or 0
    champagne_total = query.with_entities(func.sum(DailySales.champagne_count)).scalar() or 0
    catch_total = query.with_entities(func.sum(DailySales.catch_count)).scalar() or 0
    
    return {
        "date": target,
        "total_sales": daily_total,
        "drink_count": drinks_total,
        "champagne_count": champagne_total,
        "catch_count": catch_total
    }

# æœˆæ¬¡å£²ä¸Šé›†è¨ˆAPIï¼ˆèªè¨¼å¿…é ˆï¼‰
@app.get("/api/sales/monthly-summary")
def get_monthly_summary(
    year: int = None, 
    month: int = None, 
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    if not year:
        year = datetime.now().year
    if not month:
        month = datetime.now().month
    
    # æ¨©é™ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    query = db.query(DailySales).filter(
        extract('year', DailySales.date) == year,
        extract('month', DailySales.date) == month
    )
    if current_user.role != "manager":
        query = query.filter(DailySales.employee_name == current_user.name)
    
    # æœˆæ¬¡å£²ä¸Šåˆè¨ˆ
    monthly_total = query.with_entities(func.sum(DailySales.total_sales)).scalar() or 0
    drinks_total = query.with_entities(func.sum(DailySales.drink_count)).scalar() or 0
    champagne_total = query.with_entities(func.sum(DailySales.champagne_count)).scalar() or 0
    
    return {
        "year": year,
        "month": month,
        "total_sales": monthly_total,
        "drink_count": drinks_total,
        "champagne_count": champagne_total
    }

# å¾“æ¥­å“¡åˆ¥å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°APIï¼ˆåº—é•·ã®ã¿ï¼‰
@app.get("/api/sales/employee-ranking")
def get_employee_ranking(
    year: int = None, 
    month: int = None, 
    db: Session = Depends(get_db),
    current_user: User = Depends(require_manager)
):
    if not year:
        year = datetime.now().year
    if not month:
        month = datetime.now().month
    
    # å¾“æ¥­å“¡åˆ¥ã®å£²ä¸Šåˆè¨ˆï¼ˆåº—é•·ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
    ranking = db.query(
        DailySales.employee_name,
        func.sum(DailySales.total_sales).label('total_sales'),
        func.sum(DailySales.drink_count).label('total_drinks'),
        func.sum(DailySales.champagne_count).label('total_champagne'),
        func.sum(DailySales.catch_count).label('total_catch'),
        func.sum(DailySales.work_hours).label('total_hours')
    ).filter(
        extract('year', DailySales.date) == year,
        extract('month', DailySales.date) == month
    ).group_by(DailySales.employee_name).order_by(
        func.sum(DailySales.total_sales).desc()
    ).all()
    
    return [
        {
            "employee_name": r.employee_name,
            "total_sales": r.total_sales,
            "total_drinks": r.total_drinks,
            "total_champagne": r.total_champagne,
            "total_catch": r.total_catch,
            "total_hours": r.total_hours
        }
        for r in ranking
    ]

# å£²ä¸Šãƒ‡ãƒ¼ã‚¿å‰Šé™¤APIï¼ˆèªè¨¼å¿…é ˆã€åº—é•·ã®ã¿ï¼‰
@app.delete("/api/sales/{sales_id}")
def delete_sales(
    sales_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    sales = db.query(DailySales).filter(DailySales.id == sales_id).first()
    if not sales:
        raise HTTPException(status_code=404, detail="å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šåº—é•·ã®ã¿å‰Šé™¤å¯èƒ½
    if current_user.role != "manager":
        raise HTTPException(status_code=403, detail="ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“")
    
    db.delete(sales)
    db.commit()
    return {"message": "å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"}

# æ—¥å ±å‰Šé™¤APIï¼ˆèªè¨¼å¿…é ˆã€åº—é•·ã®ã¿ï¼‰
@app.delete("/api/daily-report/{report_id}")
def delete_daily_report(
    report_id: int,
    db: Session = Depends(get_db),
    current_user: User = Depends(get_current_active_user)
):
    report = db.query(DailyReport).filter(DailyReport.id == report_id).first()
    if not report:
        raise HTTPException(status_code=404, detail="æ—¥å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    # æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼šåº—é•·ã®ã¿å‰Šé™¤å¯èƒ½
    if current_user.role != "manager":
        raise HTTPException(status_code=403, detail="ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“")
    
    db.delete(report)
    db.commit()
    return {"message": "æ—¥å ±ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"}

# ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
@app.get("/api/debug/cors")
async def debug_cors():
    return {"message": "CORS test successful", "status": "OK"}

if __name__ == "__main__":
    # åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ãƒˆã‚’æ¢ã—ã¦èµ·å‹•
    import socket
    
    def find_free_port(start_port=8000, max_port=8010):
        for port in range(start_port, max_port):
            try:
                with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
                    s.bind(('localhost', port))
                    return port
            except OSError:
                continue
        return None
    
    port = find_free_port()
    if port:
        print(f"ğŸš€ ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒ¼ãƒˆ {port} ã§èµ·å‹•ã—ã¾ã™...")
        uvicorn.run(app, host="0.0.0.0", port=port)
    else:
        print("âŒ åˆ©ç”¨å¯èƒ½ãªãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (8000-8010)")
        print("ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä½¿ç”¨ä¸­ã®ãƒãƒ¼ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„:")
        print("lsof -i :8000")